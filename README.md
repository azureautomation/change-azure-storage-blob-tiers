Change Azure Storage Blob Tiers
===============================

            

This script will scan a designated storage account for all blobs, it will then set the tier (Hot, Cool or Archive) for each blob that is older then a retention period or days in which you specify.


Setting object level access tier is only supported for Standard LRS, GRS, and RA-GRS Blob Storage and General Purpose V2 Accounts. [https://aka.ms/blobtiering](https://aka.ms/blobtiering)


To run this script interactively and for more information, see
[my blog post](https://marckean.com/2018/05/27/change-azure-storage-blob-tiers/) on it.


When running the Azure Automation runbook, you will need to gain access and have admin privileges, you can either use:


  *  pre-configured credentials in Azure Automation (an AAD user account (not Microsoft/Hotmail) account)

  *  a better, more preferred way, using an **
AAD App** and **Certificate** based authentication

  *  Follow my blog on how to setup [AAD Service Principal Certificate Authentication](https://marckean.com/2017/06/05/aad-service-principal-certificate-authentication/) - it's pretty easy,
 simply run a PowerShell script 


[](<#     .SYNOPSIS         This Azure Automation runbook automates tiering of blobs in Azure Storage Accounts.       .DESCRIPTION         This script will scan a designated storage account for all blobs, it will then set the tier (Hot, Cool or Archive) for each         blob that is older then a retention period of days in which you specify.          Setting object level access tier is only supported for Standard LRS, GRS, and RA-GRS Blob Storage and General Purpose          V2 Accounts. https://aka.ms/blobtiering          This is a PowerShell runbook, as opposed to a PowerShell Workflow runbook.      .PARAMETER AzureCredentialName         The name of the PowerShell credential asset in the Automation account that contains username and password         for the account used to connect to Azure subscription.          For for details on credential configuration, see:         http://azure.microsoft.com/blog/2014/08/27/azure-automation-authenticating-to-azure-using-azure-active-directory/          .PARAMETER AzureSubscriptionID         The ID of Azure subscription          .PARAMETER StorageAccountName         The Storage Account name in your subscription in which to have this script to scan for blobs, as potential blobs         to change the tier on.      .PARAMETER $StorageTier         The Tier you want to set older blobs to. Can be either - Hot | Cool | Archive.      .PARAMETER $DaysOld         Enter the number of days retention you want to set, the tier will be set on any older blobs.      .EXAMPLE         For testing examples, see the documentation at:          https://marckean.com          .INPUTS         None.      .OUTPUTS         Human-readable informational and error messages produced during the job. Not intended to be consumed by another runbook. #>  param(     [parameter(Mandatory=$false)] 9;[String] $AzureCredentialName = 'Use *Default Automation Credential* Asset',     [parameter(Mandatory=$false)] 9;[String] $AzureSubscriptionID = 'Use *Default Azure Subscription* Variable Value',     [parameter(Mandatory=$true)] 9;[String] $StorageAccountName = 'mystorageaccountname',     [parameter(Mandatory=$true)] 9;[String] $StorageTier = 'Hot / Cool / Archive',     [parameter(Mandatory=$true)] 9;[int]$DaysOld )  # Main content $azureCredential = Get-AutomationPSCredential -Name $AzureCredentialName $AzureSubscriptionID = Get-AutomationVariable -Name $AzureSubscriptionID  if($azureCredential -eq $null)  {      throw 'Failed to get credential with name [$AzureCredentialName]'  }   # Connect via Azure Resource Manager   Login-AzureRmAccount -Credential $azureCredential Select-AzureRmSubscription -SubscriptionId $AzureSubscriptionID  # Setup the Storage Connection stuff $StgAcct = Get-AzureRmStorageAccount | Where-Object {($_.StorageAccountName -eq $StorageAccountName) -and ($_.sku.tier -eq 'Standard') `                                                               -and ($_.Kind -eq 'StorageV2' -or $_.Kind -eq 'BlobStorage')}  if ($StgAcct) {  $StgAcctKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $StgAcct.ResourceGroupName `                                             -Name $StgAcct.StorageAccountName).Value[0]  $StgAcctContext = New-AzureStorageContext -StorageAccountName $StgAcct.StorageAccountName `                                           -StorageAccountKey $StgAcctKey $StorageContainers = Get-AzureStorageContainer -Context $StgAcctContext  # Cycle through all blobs in the storage account $Blobs = @() foreach($StorageContainer in $StorageContainers){ $Blobs += Get-AzureStorageBlob -Context $StgAcctContext -Container $StorageContainer.Name }  # Date Logic $UTCDate = (Get-Date).ToUniversalTime() $RetentionDate = $UTCDate.AddDays(-$DaysOld) $EarmarkedBlobs = $Blobs | Where-Object {$_.lastmodified.DateTime -le $RetentionDate}  # Change the Tier on the blobs Foreach($Blob in $EarmarkedBlobs){ #Set tier of all blobs to desired tier $blob.icloudblob.SetStandardBlobTier($StorageTier) } cls Write-Host -ForegroundColor Green '`n`nDone... Complete. Check your Blog Tiers in the portal.`n'  } else {  Write-Error 'Your selected Storage account cannot be used, most likely because it's ` not a V2 Storage account, a blob storage account or it's not a Standard Storage account'  })


Before using Azure Automation, be sure to update all the modules - this will take a little while to complete


[](<#     .SYNOPSIS         This Azure Automation runbook automates tiering of blobs in Azure Storage Accounts.       .DESCRIPTION         This script will scan a designated storage account for all blobs, it will then set the tier (Hot, Cool or Archive) for each         blob that is older then a retention period of days in which you specify.          Setting object level access tier is only supported for Standard LRS, GRS, and RA-GRS Blob Storage and General Purpose          V2 Accounts. https://aka.ms/blobtiering          This is a PowerShell runbook, as opposed to a PowerShell Workflow runbook.      .PARAMETER AzureCredentialName         The name of the PowerShell credential asset in the Automation account that contains username and password         for the account used to connect to Azure subscription.          For for details on credential configuration, see:         http://azure.microsoft.com/blog/2014/08/27/azure-automation-authenticating-to-azure-using-azure-active-directory/          .PARAMETER AzureSubscriptionID         The ID of Azure subscription          .PARAMETER StorageAccountName         The Storage Account name in your subscription in which to have this script to scan for blobs, as potential blobs         to change the tier on.      .PARAMETER $StorageTier         The Tier you want to set older blobs to. Can be either - Hot | Cool | Archive.      .PARAMETER $DaysOld         Enter the number of days retention you want to set, the tier will be set on any older blobs.      .EXAMPLE         For testing examples, see the documentation at:          https://marckean.com          .INPUTS         None.      .OUTPUTS         Human-readable informational and error messages produced during the job. Not intended to be consumed by another runbook. #>  param(     [parameter(Mandatory=$false)] 9;[String] $AzureCredentialName = 'Use *Default Automation Credential* Asset',     [parameter(Mandatory=$false)] 9;[String] $AzureSubscriptionID = 'Use *Default Azure Subscription* Variable Value',     [parameter(Mandatory=$true)] 9;[String] $StorageAccountName = 'mystorageaccountname',     [parameter(Mandatory=$true)] 9;[String] $StorageTier = 'Hot / Cool / Archive',     [parameter(Mandatory=$true)] 9;[int]$DaysOld )  # Main content $azureCredential = Get-AutomationPSCredential -Name $AzureCredentialName $AzureSubscriptionID = Get-AutomationVariable -Name $AzureSubscriptionID  if($azureCredential -eq $null)  {      throw 'Failed to get credential with name [$AzureCredentialName]'  }   # Connect via Azure Resource Manager   Login-AzureRmAccount -Credential $azureCredential Select-AzureRmSubscription -SubscriptionId $AzureSubscriptionID  # Setup the Storage Connection stuff $StgAcct = Get-AzureRmStorageAccount | Where-Object {($_.StorageAccountName -eq $StorageAccountName) -and ($_.sku.tier -eq 'Standard') `                                                               -and ($_.Kind -eq 'StorageV2' -or $_.Kind -eq 'BlobStorage')}  if ($StgAcct) {  $StgAcctKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $StgAcct.ResourceGroupName `                                             -Name $StgAcct.StorageAccountName).Value[0]  $StgAcctContext = New-AzureStorageContext -StorageAccountName $StgAcct.StorageAccountName `                                           -StorageAccountKey $StgAcctKey $StorageContainers = Get-AzureStorageContainer -Context $StgAcctContext  # Cycle through all blobs in the storage account $Blobs = @() foreach($StorageContainer in $StorageContainers){ $Blobs += Get-AzureStorageBlob -Context $StgAcctContext -Container $StorageContainer.Name }  # Date Logic $UTCDate = (Get-Date).ToUniversalTime() $RetentionDate = $UTCDate.AddDays(-$DaysOld) $EarmarkedBlobs = $Blobs | Where-Object {$_.lastmodified.DateTime -le $RetentionDate}  # Change the Tier on the blobs Foreach($Blob in $EarmarkedBlobs){ #Set tier of all blobs to desired tier $blob.icloudblob.SetStandardBlobTier($StorageTier) } cls Write-Host -ForegroundColor Green '`n`nDone... Complete. Check your Blog Tiers in the portal.`n'  } else {  Write-Error 'Your selected Storage account cannot be used, most likely because it's ` not a V2 Storage account, a blob storage account or it's not a Standard Storage account'  })


![Image](https://github.com/azureautomation/change-azure-storage-blob-tiers/raw/master/2018-05-27_1541.png)


[](<#     .SYNOPSIS         This Azure Automation runbook automates tiering of blobs in Azure Storage Accounts.       .DESCRIPTION         This script will scan a designated storage account for all blobs, it will then set the tier (Hot, Cool or Archive) for each         blob that is older then a retention period of days in which you specify.          Setting object level access tier is only supported for Standard LRS, GRS, and RA-GRS Blob Storage and General Purpose          V2 Accounts. https://aka.ms/blobtiering          This is a PowerShell runbook, as opposed to a PowerShell Workflow runbook.      .PARAMETER AzureCredentialName         The name of the PowerShell credential asset in the Automation account that contains username and password         for the account used to connect to Azure subscription.          For for details on credential configuration, see:         http://azure.microsoft.com/blog/2014/08/27/azure-automation-authenticating-to-azure-using-azure-active-directory/          .PARAMETER AzureSubscriptionID         The ID of Azure subscription          .PARAMETER StorageAccountName         The Storage Account name in your subscription in which to have this script to scan for blobs, as potential blobs         to change the tier on.      .PARAMETER $StorageTier         The Tier you want to set older blobs to. Can be either - Hot | Cool | Archive.      .PARAMETER $DaysOld         Enter the number of days retention you want to set, the tier will be set on any older blobs.      .EXAMPLE         For testing examples, see the documentation at:          https://marckean.com          .INPUTS         None.      .OUTPUTS         Human-readable informational and error messages produced during the job. Not intended to be consumed by another runbook. #>  param(     [parameter(Mandatory=$false)] 9;[String] $AzureCredentialName = 'Use *Default Automation Credential* Asset',     [parameter(Mandatory=$false)] 9;[String] $AzureSubscriptionID = 'Use *Default Azure Subscription* Variable Value',     [parameter(Mandatory=$true)] 9;[String] $StorageAccountName = 'mystorageaccountname',     [parameter(Mandatory=$true)] 9;[String] $StorageTier = 'Hot / Cool / Archive',     [parameter(Mandatory=$true)] 9;[int]$DaysOld )  # Main content $azureCredential = Get-AutomationPSCredential -Name $AzureCredentialName $AzureSubscriptionID = Get-AutomationVariable -Name $AzureSubscriptionID  if($azureCredential -eq $null)  {      throw 'Failed to get credential with name [$AzureCredentialName]'  }   # Connect via Azure Resource Manager   Login-AzureRmAccount -Credential $azureCredential Select-AzureRmSubscription -SubscriptionId $AzureSubscriptionID  # Setup the Storage Connection stuff $StgAcct = Get-AzureRmStorageAccount | Where-Object {($_.StorageAccountName -eq $StorageAccountName) -and ($_.sku.tier -eq 'Standard') `                                                               -and ($_.Kind -eq 'StorageV2' -or $_.Kind -eq 'BlobStorage')}  if ($StgAcct) {  $StgAcctKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $StgAcct.ResourceGroupName `                                             -Name $StgAcct.StorageAccountName).Value[0]  $StgAcctContext = New-AzureStorageContext -StorageAccountName $StgAcct.StorageAccountName `                                           -StorageAccountKey $StgAcctKey $StorageContainers = Get-AzureStorageContainer -Context $StgAcctContext  # Cycle through all blobs in the storage account $Blobs = @() foreach($StorageContainer in $StorageContainers){ $Blobs += Get-AzureStorageBlob -Context $StgAcctContext -Container $StorageContainer.Name }  # Date Logic $UTCDate = (Get-Date).ToUniversalTime() $RetentionDate = $UTCDate.AddDays(-$DaysOld) $EarmarkedBlobs = $Blobs | Where-Object {$_.lastmodified.DateTime -le $RetentionDate}  # Change the Tier on the blobs Foreach($Blob in $EarmarkedBlobs){ #Set tier of all blobs to desired tier $blob.icloudblob.SetStandardBlobTier($StorageTier) } cls Write-Host -ForegroundColor Green '`n`nDone... Complete. Check your Blog Tiers in the portal.`n'  } else {  Write-Error 'Your selected Storage account cannot be used, most likely because it's ` not a V2 Storage account, a blob storage account or it's not a Standard Storage account'  })

 

        
    
TechNet gallery is retiring! This script was migrated from TechNet script center to GitHub by Microsoft Azure Automation product group. All the Script Center fields like Rating, RatingCount and DownloadCount have been carried over to Github as-is for the migrated scripts only. Note : The Script Center fields will not be applicable for the new repositories created in Github & hence those fields will not show up for new Github repositories.
